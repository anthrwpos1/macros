Универсальные макросы к Owen Logic для построения высокоэффективных автоматических регуляторов.

Общая информация:
Макросы именуются короткими наименованиями на основе выполняемой функции.
В квадратных скобках указываются макросы, от которых зависит данный, для того, чтобы в случае усовершенствования какого либо макроса видеть, где его еще нужно заменить.

Макрос CLK
Выдает синхронизирующие импульсы для построения систем, для управления которыми нужны дискретные импульсы заданной длительности.

Макрос DT
Определяет время программного цикла.
Используется для отладки, после чего может быть заменен постоянной равной времени цикла для установившейся программы.

Макрос fDTRIG
Является аналогом Д-триггера для чисел с плавающей точкой.
При значении CLK=0 хранит последнее значение, которое было на входе при CLK=1. При запуске программы хранит ноль.
При значении CLK=1 копирует на выход входящее значение и после снятия единицы, запоминает его.

Макрос fSAW
Генерирует пилообразный ступенчатый сигнал с периодом t импульсов CLK.
Генерируется сигнал значения которого лежат в интервале [1/t...1]
! Минимальным значением t обеспечивающим корректную работу является t=2.
Пользователю следует обеспечить защиту от возможного попадания в ввод t нуля или единицы. 

Макрос PWM
Широтно-частотный дискретный двухпозиционный импульсный модулятор.
    Входы
period - период импульсов в импульсах CLK
fill - коэффициент заполнения.
! значение коэффициента заполнения должно лежать в интервале [-1...1].
Пользователю следует обеспечить невозможность подавать значения вне этого интервала.
    Выходы
OUT+ - выход положительного управляющего сигнала
OUT- - выход отрицательного управляющего сигнала
inc - значение внутреннего счетчика.
    Макрос обладает следующими особенностями:
1) дискретность - интервал подачи сигнала управления OUT+, OUT- строго пропорционален периоду импульса CLK.
2) кумулятивность - Весь объем невыполненного управления суммируется и отрабатывается, когда его значение превысит минимальный такт. Таким образом, сигналы малого значения приводят к частотно-импульсной модуляции.
3) Одновременно работает или вывод OUT+ или OUT-. Одновременное их срабатывание исключается, если на вход не подается сигнал по модулю выше единицы.
4) строгое соблюдение периода: никакие колебания коэффициента заполнения в рамках допустимых значений не могут вызвать включение и отключение управления несколько раз за период.

Макрос VLV
Управление клапанами.
    Входы
Period - период управления в секундах
STP - минимальный шаг управления в секундах
t_full - время полного хода клапана
target - требуемая позиция клапана (от 0 до 1)
    Выходы
OUT+ - выход открытия
OUT- - выход закрытия
current - текущее положение
    Макрос обладает следующими особенностями
1) дискретность - Интервал подачи управления строго пропорционален времени минимального шага
2) исключительность - подается сигнал или на открытие или на закрытие
3) строгое соблюдение периода: никакие колебания входа target не могут вызвать включение и отключение управления несколько раз за период.
4) выборка люфтов: если входящее значение target ниже нуля или выше единицы - на клапан подается дополнительное воздействие для доводки его до крайнего положения (концевика).
Для работы этой фичи, не следует ограничивать подаваемое воздействие интервалом [0...1]
 
Макрос MAVG
Скользящая средняя.
    Входы:
τ - время усреднения
dt - время программного цикла
input - вход фильтруемой величины
    Выходы:
Out - выход отфильтрованной величины
    Макрос обладает следующими особенностями
1) плавный ввод в работу: для того, чтобы предотвратить длительный выход отфильтрованной величины на актуальное среднее значение из-за случайного попадания на вход выброса в момент начала работы или увеличения времени фильтрации, фильтр производит предварительное равномерное усреднение по величине времени равной постоянной усреднения, после чего переходит на экспоненциальную весовую функцию.
Эта особенность выглядит как недофильтрация в момент включения или резкой смены (увеличения) постоянной времени фильтрации.
2) Защита от нуля в вводе dt
3) компенсация потери точности float-чисел: добавки в текущее значение могут быть незначительными. Для устранения их недоучета в алгоритм введена петля компенсации.

Макрос 2MAVG
Скользящая средняя второго порядка
    Входы:
τ - время усреднения
dt - время программного цикла
input - вход фильтруемой величины
    Выходы:
Out - выход отфильтрованной величины
Diff - первая производная
    Макрос обладает теми-же особенностями что и MAVG
Кроме них в макрос введен дополнительный вывод первой производной фильтруемой величины.
В отличии от MAVG, 2MAVG обладает гладкой весовой функцией (имеющей непрерывную первую производную), поэтому она производит отфильтрованную первую производную с компенсацией потери точности.

Макрос PID
Пропорционально-Интегрально-Дифференциальный независимый регулятор.
     Входы:
X - Текущее значение регулируемой величины
dX - производная регулируемой величины. Алгоритм не вычисляет её самостоятельно. Для получения её значения согласованного с текущим отфильтрованным значением рекомендуется использовать скользящую среднюю второго порядка, или любой другой фильтр с гладкой весовой функцией.
X0 - Уставка.
Xp - пропорциональный коэффициент в обратных единицах регулируемой величины.
T_I - интегралное время в секундах
T_D - Дифференциальное время в секундах
Q0_in - вход "опорной точки": значение регулируемой величины при котором выход управления равен нулю. Используйте значение поданное вручную для коррекции при необходимости. Иначе соедините линией задержки с выходом Q0_out
dt - значение программного цикла в секундах
Qmin - минимальное нормальное значение выхода управления. При значении обратной связи ниже данного блокируется снижение интегральной составляющей выхода (рост опорной точки).
Qmax - максимальное нормальное значение выхода управления. При превышении данного значения на входе обратной связи блокируется рост интегральной составляющей (снижение опорной точки).
!!! выход управления не ограничивается данными значениями ! Данные пределы предназначены только для блокировки насыщения интегральной составляющей. Используйте реальные пределы регулирования в случае управления системой, непосредственно управляемой во всем диапазоне пределов. В случае управления системой, актуальные пределы которой неизвестны, которая управляется косвенно, используйте в качестве пределов измеренное значение плюс-минус некий адекватный допуск.
LB - обратная связь, актуальное значение управления. Подавайте актуальное значение для корректной отработки интегральной составляющей. Если управление происходит непосредственно, то подавайте значение выхода после его ограничения допустимыми пределами. Если в системе возможен ручной режим, на обратную связь подается непосредственно действующее значение, в том числе с учетом выбора вручную. Это обеспечит адекватный переходной процесс при отключении ручного режима. Если система управляется косвенно, сюда подается измеренное значение величины, уставку которой вычисляет данный регулятор.
    Выходы:
Q - Выход управления. ! Помните о том, что он будет выходить за пределы заданные входами Qmin, Qmax !
QP - пропорциональная составляющая. Используйте для отладки коэффициентов
QI - интегральная составляющая. Используйте для отладки.
QD - дифференциальная составляющая. Используйте её значение для отладки.
Q0_out - выход опорной точки. соедините линией задержки со входом напрямую, если её не планируется корректировать, либо посредством переменной доступной для редактирования.
Чтобы редактирование работало, следует выбрать режим записи переменной "после чтения".
I_F - коэффициент влияния смены уставки. При смене уставки адекватное значение опорной точки, обеспечивающее равновесие в системе тоже изменяется. В принципе, оно самостоятельно определяется в процессе интегрального регулирования, но вы можете улучшить качество отработки смены уставки, если на опыте подберете данный коэффициент.
задание 0 означает, что опорная точка при смене уставки не будет изменяться, таким образом при достижении регулируемой величиной уставки управление будет больше текущего на величину смены уставки делить на пропорциональный коэффициент.
Задание 1 означает, что опорная точка при смене уставки будет изменена на значение смены уставки, таким образом при достижении регулируемой величиной уставки величина управления будет той-же.
    Данный макрос имеет следующие особенности:
1) Доступ к текущим значениям составляющих для отладки.
2) возможность изменения интегральной составляющей посредством опорной точки
3) универсальность - вы можете использовать данный макрос для вычисления некой предварительной величины, которая управляется опосредованно, подавая в обратную связь её измеренное значение.
4) независимость - макрос обрабатывает отдельно пропорциональную, интегральную и дифференциальную составляющую, что исключает некоторые широко распространенные на рынке ПИД-регуляторов ошибки управления.
5) внешняя фильтрация: макрос не выполняет никакой фильтрации, и дифференцирования, так что его работа проста и предсказуема. Он не создает никаких непонятных задержек, зависящих от реализации фильтра или дифференциатора.

Макрос WBP
Вычисляет давление насыщенного водяного пара при заданной температуре воздуха.
Используется для вычислений влажности по показаниям двух термометров.

Макросы распространяются на основе свободной лицензии GNU GPLv3 см файл LICENCE
Используйте на здоровье!
Любые комментарии, вопросы, исправления и улучшения приветствуются.
Форум АСУ компании ОВЕН посвященный системе Owen Logic, где вы можете задать любые вопросы
http://www.owen.ru/forum/forumdisplay.php?f=63
Последняя версия моих макросов доступна по адресу
https://github.com/anthrwpos1/macros